<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô AI Ultra Scan</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    <style>
        :root {
            --bg: #F8FAFC; --text: #2D3436; --accent: #74B9FF;
            --mint: #55E6C1; --rose: #FF7675; --yellow: #F1C40F;
        }

        * { box-sizing: border-box; font-family: 'Prompt', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #CBD5E0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }

        .app-shell {
            width: 100%; max-width: 414px; height: 92vh;
            background: var(--bg); border-radius: 40px;
            position: relative; overflow: hidden; box-shadow: 0 30px 60px rgba(0,0,0,0.2);
            border: 8px solid #FFF;
        }

        .main-logo { width: 120px; height: 120px; object-fit: cover; border-radius: 50%; margin-bottom: 15px; border: 3px solid #eee; }
        .mini-logo { width: 35px; height: 35px; object-fit: cover; border-radius: 50%; vertical-align: middle; }
        
        .page-container { display: flex; width: 100%; height: 100%; overflow-x: auto; scroll-snap-type: x mandatory; scroll-behavior: smooth; }
        .page-container::-webkit-scrollbar { display: none; }
        .page { min-width: 100%; height: 100%; padding: 25px; padding-bottom: 110px; scroll-snap-align: start; display: flex; flex-direction: column; overflow-y: auto; }

        #p-login { position: absolute; inset: 0; z-index: 1000; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .header { font-size: 24px; font-weight: 600; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .wish-card { background: #FFF9DB; border-radius: 25px; padding: 15px; display: flex; position: relative; margin-bottom: 15px; justify-content: space-between; align-items: center;}
        
        .circle-ui { width: 220px; height: 220px; border-radius: 50%; background: white; border: 10px solid var(--accent); display: flex; flex-direction: column; justify-content: center; align-items: center; margin: 20px auto; }

        .nav { position: absolute; bottom: 0; width: 100%; height: 85px; background: white; display: flex; justify-content: space-around; padding-bottom: 10px; border-top: 1px solid #EEE; z-index: 100; }
        .nav-item { text-align: center; color: #B2BEC3; padding-top: 15px; flex: 1; cursor: pointer; }
        .nav-item.active { color: var(--text); font-weight: bold; }

        /* Camera UI */
        .cam-container { position: relative; width: 100%; height: 280px; border-radius: 25px; overflow: hidden; background: #000; margin-bottom: 15px; border: 4px solid #eee; }
        #video-preview { width: 100%; height: 100%; object-fit: cover; }
        #target-frame { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 220px; height: 140px; border: 2px dashed #74B9FF; border-radius: 10px; box-shadow: 0 0 0 1000px rgba(0,0,0,0.5); pointer-events: none; }
        #target-frame::after { content: "‡πÄ‡∏•‡πá‡∏á‡πÄ‡∏•‡∏Ç ‡πë ‡πï ‡πë‡πê ‡∏´‡∏£‡∏∑‡∏≠ 1 5 10 ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö"; position: absolute; bottom: -45px; left: -20px; width: 260px; color: #74B9FF; font-size: 11px; font-weight: bold; }

        .modal { position: absolute; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: flex-end; z-index: 2000; }
        .modal-content { width: 100%; background: white; border-radius: 30px 30px 0 0; padding: 25px; }
        .btn-p { width: 100%; padding: 15px; border-radius: 15px; border: none; background: var(--text); color: white; font-weight: 600; cursor: pointer;}
        .fab { position: absolute; bottom: 100px; right: 20px; width: 60px; height: 60px; background: var(--text); color: white; border-radius: 20px; display: flex; justify-content: center; align-items: center; font-size: 25px; z-index: 99; cursor: pointer;}
        
        #scan-loading { display: none; margin-top: 10px; color: var(--accent); font-weight: bold; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="app-shell">
    <div id="p-login">
        <img src="lol.png" class="main-logo">
        <h1>‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h1>
        <input type="text" id="user" style="width:80%; padding:15px; margin-bottom:10px; border-radius:15px; border:1px solid #ddd;" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (p)">
        <input type="password" id="pass" style="width:80%; padding:15px; margin-bottom:10px; border-radius:15px; border:1px solid #ddd;" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (2172568)">
        <button class="btn-p" style="width: 80%" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div class="page-container" id="main-swiper" onscroll="handleScroll()">
        <div id="p-wish" class="page">
            <div class="header"><div><img src="lol.png" class="mini-logo"> Wishlist</div></div>
            <div id="w-container"></div>
        </div>

        <div id="p-finance" class="page">
            <div class="header">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</div>
            <div class="circle-ui"><small>‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</small><h1 id="t-val">0</h1><small>‡∏ö‡∏≤‡∏ó</small></div>
            <div style="background:white; border-radius:20px; padding:15px; flex:1"><b>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</b><div id="h-container"></div></div>
        </div>
    </div>

    <div class="fab" onclick="openM('m-scan')">üí∞</div>

    <div id="m-scan" class="modal">
        <div class="modal-content" style="text-align:center">
            <h3>ü§ñ AI ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏•‡∏Ç‡πÄ‡∏á‡∏¥‡∏ô</h3>
            <div class="cam-container">
                <video id="video-preview" autoplay playsinline></video>
                <div id="target-frame"></div>
                <canvas id="proc-canvas" style="display:none"></canvas>
            </div>
            
            <div id="scan-loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢/‡∏≠‡∏≤‡∏£‡∏ö‡∏¥‡∏Å...</div>

            <h2 id="s-result" style="display:none">
                <small style="font-size: 14px; color: #888;">AI ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö:</small><br>
                <span id="s-amt" style="color:var(--accent); font-size: 40px;">0</span> ‡∏ö‡∏≤‡∏ó
            </h2>

            <div id="scan-btns">
                <button id="snap-btn" class="btn-p" style="background:var(--accent)" onclick="captureAndProcess()">üì∏ ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏™‡πÅ‡∏Å‡∏ô</button>
                <button class="btn-p" style="background:#eee; color:#333; margin-top:10px" onclick="closeM()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>

            <div id="post-scan" style="display:none; gap:10px; margin-top:10px">
                <button class="btn-p" style="background:var(--rose)" onclick="resetScan()">‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</button>
                <button class="btn-p" style="background:var(--mint)" onclick="toSave()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏ô‡∏µ‡πâ</button>
            </div>
        </div>
    </div>
</div>

<script>
    let state = JSON.parse(localStorage.getItem('pData')) || { total: 0, wishes: [], history: [] };
    let streamActive = null;

    function renderAll() {
        document.getElementById('t-val').innerText = state.total;
        document.getElementById('h-container').innerHTML = state.history.slice(-10).map(h => `<div style="font-size:14px; padding:8px 0; border-bottom:1px dashed #eee">${h}</div>`).reverse().join('');
    }

    async function openM(id) {
        document.getElementById(id).style.display = 'flex';
        if(id === 'm-scan') {
            try {
                streamActive = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('video-preview').srcObject = streamActive;
                resetScanUI();
            } catch (err) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á"); }
        }
    }

    async function captureAndProcess() {
        const video = document.getElementById('video-preview');
        const canvas = document.getElementById('proc-canvas');
        const ctx = canvas.getContext('2d');
        const loading = document.getElementById('scan-loading');
        
        loading.style.display = 'block';
        document.getElementById('snap-btn').disabled = true;

        // 1. Crop ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (‡πÄ‡∏ô‡πâ‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏£‡∏≠‡∏ö)
        canvas.width = 400; canvas.height = 240;
        ctx.drawImage(video, video.videoWidth*0.2, video.videoHeight*0.3, video.videoWidth*0.6, video.videoHeight*0.4, 0, 0, 400, 240);
        
        // 2. ‡∏õ‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏û‡πÄ‡∏õ‡πá‡∏ô GrayScale (‡∏Ç‡∏≤‡∏ß‡∏î‡∏≥) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
        let imgData = ctx.getImageData(0,0, canvas.width, canvas.height);
        for (let i = 0; i < imgData.data.length; i += 4) {
            let avg = (imgData.data[i] + imgData.data[i+1] + imgData.data[i+2]) / 3;
            imgData.data[i] = imgData.data[i+1] = imgData.data[i+2] = avg;
        }
        ctx.putImageData(imgData, 0, 0);

        const dataUrl = canvas.toDataURL('image/png');

        // 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏±‡∏ô Tesseract AI
        try {
            const result = await Tesseract.recognize(dataUrl, 'tha+eng', {
                // ‡∏à‡∏π‡∏ô‡πÉ‡∏´‡πâ AI ‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏Ñ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡∏•‡∏î‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
                tessedit_char_whitelist: '0123456789‡πê‡πë‡πí‡πì‡πî‡πï‡πñ‡πó‡πò‡πô',
            });
            
            const value = parseMoneyValue(result.data.text);
            
            loading.style.display = 'none';
            window.lastScan = value;
            document.getElementById('s-amt').innerText = value;
            document.getElementById('s-result').style.display = 'block';
            document.getElementById('post-scan').style.display = 'flex';
            document.getElementById('scan-btns').style.display = 'none';
            
            if(streamActive) streamActive.getTracks().forEach(t => t.stop());
        } catch (e) {
            alert("AI ‡∏°‡∏∂‡∏ô‡∏á‡∏á... ‡∏•‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
            resetScan();
        }
    }

    function parseMoneyValue(text) {
        const thDigits = {'‡πê':0,'‡πë':1,'‡πí':2,'‡πì':3,'‡πî':4,'‡πï':5,'‡πñ':6,'‡πó':7,'‡πò':8,'‡πô':9};
        let cleanText = text.replace(/[‡πê-‡πô]/g, s => thDigits[s]);
        
        // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏ó‡∏¢ (‡πÅ‡∏ö‡∏á‡∏Ñ‡πå ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 10, 5, 1)
        const validValues = [1000, 500, 100, 50, 20, 10, 5, 1];
        for (let val of validValues) {
            if (cleanText.includes(val.toString())) return val;
        }
        return 0; 
    }

    function resetScanUI() {
        document.getElementById('s-result').style.display = 'none';
        document.getElementById('post-scan').style.display = 'none';
        document.getElementById('scan-btns').style.display = 'block';
        document.getElementById('snap-btn').disabled = false;
        document.getElementById('scan-loading').style.display = 'none';
    }

    function resetScan() {
        resetScanUI();
        openM('m-scan');
    }

    function toSave() {
        if(window.lastScan > 0) {
            state.total += window.lastScan;
            state.history.push(`üí∞ ‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏ö ${window.lastScan} ‡∏ö‡∏≤‡∏ó`);
            localStorage.setItem('pData', JSON.stringify(state));
            renderAll();
        } else {
            alert("AI ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö ‡∏•‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÜ ‡∏ô‡∏∞");
        }
        closeM();
    }

    function closeM() {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        if(streamActive) streamActive.getTracks().forEach(t => t.stop());
    }

    function doLogin() {
        if(document.getElementById('user').value==='p' && document.getElementById('pass').value==='2172568') {
            document.getElementById('p-login').style.display = 'none';
        }
    }

    function handleScroll() {
        const index = Math.round(document.getElementById('main-swiper').scrollLeft / window.innerWidth);
        document.querySelectorAll('.nav-item').forEach((item, i) => item.classList.toggle('active', i === index));
    }

    renderAll();
</script>
</body>
</html>
